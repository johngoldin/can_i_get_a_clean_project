---
title: Changes in Apple Health Export
author: John Goldin
date: '2021-05-25'
slug: changes-in-apple-health-export
excerpt: Another post on the contents of the Apple Health Export. This post shows how some measures have changed as new version of Watch and iPhone have been released. The examples focus on resting heart rate and VO2 Max."
categories:
  - Apple-Health-Export
  - R
tags:
  - Apple-Health-Export
  - R
subtitle: ''
image: ''
draft: yes
output: 
  blogdown::html_page:
    # figure parameters based on recommendation in Hadley's book 
    toc: yes
    highlight: tango
    number_sections: false
    fig_width: 7
    out.width: "100%" 
    fig.align: "center"
    fig.asp: 0.618  
editor_options:
  markdown: 
    wrap: 72
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<div id="TOC">
<ul>
<li><a href="#resting-heart-rate">Resting Heart Rate</a></li>
<li><a href="#how-does-the-apple-watch-measure-resting-heart-rate">How does the Apple Watch measure resting heart rate?</a></li>
<li><a href="#vo2-max">VO2 Max</a></li>
<li><a href="#what-happened-to-my-million-rows-of-data">What Happened to My Million Rows of Data?</a></li>
<li><a href="#how-do-we-know-what-the-health-measures-actually-measure">How Do We Know What the Health Measures Actually Measure?</a></li>
<li><a href="#appendix-some-of-the-r-code-used-to-make-this-post">Appendix: Some of the R Code Used to Make This Post</a>
<ul>
<li><a href="#r-code-for-the-ggplot2-figures">R Code for the <code>ggplot2</code> Figures</a></li>
<li><a href="#removing-duplicate-rows-in-the-export">Removing Duplicate Rows in the Export</a></li>
</ul></li>
</ul>
</div>

<p>This is a follow-up to an <a href="/blog/apple-health-export-1/">earlier post</a>
exploring the Apple Health Export. The earlier post describes how
to export the Health data from the iPhone and import it into R.</p>
<p>This post will look at issues of the stability of how some
summary measures are defined and look for other changes in the export.</p>
<p>At the end of the post I have included some of the
R code used to create this post to illustrate some
tips on using <code>ggplot2</code>
offered by <a href="https://z3tt.github.io/OutlierConf2021/">Cédric Scherer</a></p>
<div id="resting-heart-rate" class="section level3">
<h3>Resting Heart Rate</h3>
<p>According to <a href="https://en.wikipedia.org/wiki/Heart_rate#Resting_heart_rate">Wikipedia</a>:</p>
<blockquote>
<p>resting heart rate … is defined as the heart rate when a person is awake,
in a neutrally temperate environment, and has not been subject to any recent
exertion or stimulation, such as stress or surprise.</p>
</blockquote>
<p>But note the passive voice. In practice I have not found clarity about
the conceptual definition of resting heart rate. One must
be aware of the <em>operational definition</em>, that is, how is the measurement
actually made. Let’s start with the national norms compiled by the CDC.
They conduct an annual survey called NHANES
(National Health and Nutrition Examination Survey). NHANES
includes information on pulse rate as part of their
measurement of blood pressure. The protocol for collecting data
for NHANES is specified in exhaustive detail in their
<a href="https://wwwn.cdc.gov/Nchs/Data/Nhanes/2015-2016/Manuals/2015_Physician_Examination_Procedures_Manual.pdf">physician procedures manual</a>.
For individuals eight years or older, pulse is taken as
part of the procedure for measuring blood pressure. First there are elaborate
instructions on how to measure for the size of blood pressure cuff needed
and how to place the cuff. The next step is the measurement of pulse:</p>
<blockquote>
<p>The pulse is taken after the SP [subject person] has been seated and resting
quietly for at least 3 minutes. Position the arm with the right palm
upward. Palpate the radial pulse on the lateral flexor surface of the wrist
with the pads of the index and middle figure. The pulse is counted for
30 seconds and the number of beats in a 30-second period is entered in
the heart rate field.</p>
</blockquote>
<p>So the national norms for heart rate are based on putting on a blood
pressure cuff, sitting quietly for at least
3 minutes, and then a physician takes your pulse. That procedure leads to
articles such as
<a href="https://pubmed.ncbi.nlm.nih.gov/28132682/">Relation of Higher Resting Heart Rate to Risk of Cardiovascular Versus Noncardiovascular Death</a>
which used NHANES data to examine the association of higher resting heart rate with
mortality. In other words, the procedure is the operational definition
of “resting heart rate” in studies based on NHANES.</p>
<p>New devices
such as Fitbit or Apple Watch make the measurement procedure used
by NHANES seem like the horse and buggy days. With wearable devices,
there may be hundreds of
heart rate readings during the day. Which one is interpreted as being
the resting heart rate? The key issues is how one interprets “resting.”</p>
</div>
<div id="how-does-the-apple-watch-measure-resting-heart-rate" class="section level3">
<h3>How does the Apple Watch measure resting heart rate?</h3>
<p>Here’s what the Apple <a href="https://developer.apple.com/documentation/healthkit/hkquantitytypeidentifier/2867756-restingheartrate">developer documentation</a>
says about resting heart rate:</p>
<blockquote>
<p>Resting heart rate is commonly correlated with overall cardiovascular health. It is an estimation of the user’s lowest heart rate during periods of rest, and is intended to be used as a medically relevant metric. A resting heart rate sample is different than a sedentary heart rate sample (that is, a sample using the heartRate identifier with a HKHeartRateMotionContext.sedentary motion context). For example, if the user finishes a high-intensity workout, and then sits down to rest, the next heart rate sample may be marked as a sedentary sample, but it is still much higher than the user’s actual resting heart rate. To produce more accurate results, the system estimates the resting heart rate by analyzing sedentary heart rate samples throughout the day.</p>
</blockquote>
<blockquote>
<p>Because the resting heart rate estimates become more accurate as the day progresses, the system may delete earlier samples and replace them with better estimates. Apple Watch replaces only the samples written by the watch for the current or previous day.</p>
</blockquote>
<p>That text is fairly long and seems very concrete,
but it is not so clear what it means in practice. I will dive deep into my own data
to try to observe what is actually happening with
the measurement of resting heart rate.</p>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/base_resting_hr_figure-1.png" width="672" /></p>
<p>This figure shows my daily resting heart rate back to 2017. I have
added a smoothed curve to show the trend during this time period.
Note that resting heart rate seems to be higher in winter and lower in summer.
That’s interesting and not something I noticed until I did this graph.</p>
<p>You can also see that my heart rate is noticeably higher starting around
December of 2020. Should I interpret that as being medically significant?
Has my health changed? Has my fitness level changed?</p>
<p>We’ll see that the change is in how Apple constructs “resting heart rate”
rather than in me.</p>
<p>The next figure adds vertical green lines to show when I upgraded the
Watch OS software.</p>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/resting_hr_figure_with_version-1.png" width="672" /></p>
<p>It’s clear that resting heart rate was suddenly higher after I upgraded
to Version 7 of WatchOS. I did some searching, but the
<a href="https://www.apple.com/newsroom/2020/06/watchos-7-adds-significant-personalization-health-and-fitness-features-to-apple-watch/">release notes for Version 7</a>
don’t mention this. I did come across a brief article by
<a href="https://www.howtogeek.com/711238/why-your-resting-heart-rate-just-got-higher-on-apple-watch/">Harry Guinness</a>
in which he picked up on this change. He noted that Version 7 also introduced Apple
sleep tracking. What appears to be going on is that before Version 7, resting
heart rate was close to the lowest heart rate while one is asleep (if, like me,
you wear the watch at night). He also pointed out that when you go to the
Resting Heart Rate section of the Health app, at the bottom of the screen
there is an “about Resting Heart Rate” note that partly explains what they
are doing:</p>
<blockquote>
<p>Your resting heart rate is the average heart beats per minute
measured when you’ve been inactive or relaxed for several minutes….
Resting heart rate does not include your heart rate while you’re asleep.</p>
</blockquote>
<p>The key qualifier is “not while you’re asleep” combined with the fact that Apple didn’t
start tracking sleep until Version 7. Before Version 7 the calculation of
resting heart rate couldn’t take
note of whether or not you were asleep, only whether you were inactive.</p>
<p>So Apple isn’t hiding what they are doing, but they didn’t do anything to
help users interpret changes in their resting heart rate. On the Apple
discussion board, there’s a <a href="https://discussions.apple.com/thread/251819127">thread</a>
in which users try to puzzle out what is happening to their resting heart rate.</p>
<p>Here’s yet another graph of my resting heart rate, but in this one I show a
separate smoothed trend line for the periods before and after I upgraded to
Version 7.</p>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/resting_hr_two_parts-1.png" width="672" /></p>
<p>Just to beat this issue to death, I did a bit more digging into the details
of the Apple Health Export. For each data row of the export there is a start date
and an end date (where date in R terms is a <code>datetime</code> value with both date
and time). For resting heart rate, the start date is usually just after
midnight at the start of the new day. The end date varies quite a bit and
changes with Version 7. The next graph shows the time of day for those
end dates. You can see that after Version 7, the time of day for the
end date generally occurs before my normal bedtime, i.e., while I’m
still awake.</p>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/resting_hr_tod-1.png" width="672" /></p>
<p>No doubt Apple will improve how it identifies when one is asleep.
That may directly affect the measurement of resting heart
rate. In general terms, for the Apple Watch and for other wearables such
as Fitbit, to interpret resting heart rate you need to know whether
“resting” includes sleep time.</p>
</div>
<div id="vo2-max" class="section level3">
<h3>VO2 Max</h3>
<p>VO2 Max is the rate of oxygen
consumption during heavy exercise. Direct measures of VO2 Max involve exercising
while wearing a face mask that measures oxygen and carbon dioxide concentration
of the inhaled and exhaled air.
Obviously that’s not something your Apple Watch can do. Instead, Apple
estimates VO2 Max. The <a href="https://en.wikipedia.org/wiki/VO2_max">Wikipedia article on VO2 Max</a>
describes a number of different methods for estimating
VO2 Max. What does Apple do? Who knows. That’s the kind of thing that Apple
keeps close to the vest.</p>
<p>Here is the <a href="https://developer.apple.com/documentation/healthkit/hkquantitytypeidentifier/2867757-vo2max">description of VO2 Max</a>
provided by the Apple Developer Documentation:</p>
<blockquote>
<p>Understand Estimated Test Results</p>
<p>Apple Watch Series 3 and later estimates the user’s VO2max by measuring the user’s heart rate response to exercise. The system can generate VO2max samples after an outdoor walk, outdoor run, or hiking workout. During the outdoor activity, the user must cover relatively flat ground (a grade of less than 5% incline or decline) with adequate GPS, heart rate signal quality, and sufficient exertion. The user must maintain a heart rate approximately greater than or equal to 130% of their resting heart rate. The system can estimate VO2max ranges from 14-60 ml/kg/min</p>
<p>The user must wear their Apple Watch for at least one day before the system can generate the first vo2Max sample. Additionally, the system doesn’t generate a vo2Max sample on the user’s first workout. However, it can make estimates based on data collected outside a workout session.</p>
<p>Apple Watch estimates VO2max based on sub-maximal predictions rather than peakVO2. Users don’t need to achieve peak heart rate to receive an estimate; however, the system dose need to estimate their peak heart rate. Users who take medications that may reduce their peak heart rate can toggle a medication switch in the Health app to enable more accurate VO2max estimates.</p>
</blockquote>
<p>As with resting heart rate, let’s
look at my values for VO2 Max to see what it reveals.</p>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/vo2max-1.png" width="672" /></p>
<p>What can I make of these changes over time? It’s evident that the
estimated value of VO2 Max is
dominated by the details of how estimation is done during each version
of Watch OS. There are dramatic changes in this chart that have little (or nothing)
to do with my fitness.</p>
<p>What about the trend within each version of Watch OS? For example, during
Version 7 my VO2 Max has been on a steady upward march. No, I can’t relate
that to the personal experience of my fitness. I do a challenging three-mile
walk in the woods almost every day with an occasioinal longer walk thrown in
from time to time. It’s hard to imagine what estimation procedure would
produce these trends. In Version 7 of Watch OS perhaps the procedure starts
with an estimate based only on height, weight, age, and gender and then
modifies it based on observation of workouts. Looking at the period during
Version 6, there was a big drop on March 17, 2020 and then a big increase
on April 9. When I look at the details of the workouts during that time
period I don’t see anything that would relate to a change in estimated
VO2 Max. My concludion is that I should not attribute short-run changes in
the estimated VO2 Max to actual changes in my cardio fitness.</p>
<p>The <a href="https://www.apple.com/newsroom/2020/09/apple-watch-series-6-delivers-breakthrough-wellness-and-fitness-capabilities/">press release for Watch OS 7</a> introduced “low range VO2 Max”</p>
<blockquote>
<p>Apple Watch already estimates average and higher levels of VO2 max during vigorous outdoor walks, runs, or hikes, which many runners and other athletes monitor to improve performance.
Now, with watchOS 7, Apple Watch uses multiple sensors, including the optical heart sensor, GPS, and the accelerometer, to estimate lower levels, too.</p>
</blockquote>
<p>I don’t know whether the low range VO2 Max had any effect on me. It’s likely that
my normal daily walk was sufficient to estimate VO2 Max so they low range estimation
procedure was never needed.</p>
<p>Including an estimate of VO2 Max is an interesting concept, but so far it seem that
both the short run variations the long-term trend are affected by changes
in the estimation procedure. VO2 Max won’t be useful until Apple settles on
a stabe methodology. I look forward to seeing that someday.</p>
<p>An overall theme of this post is that one should expect there will be additional
future changes in the Apple Health Kit
as Apple works to improve their health and fitness information. Of course
we as customers want it to improve. That means that when interpreting long
term trends in the data one has to allow for the possibility that
the definition of measures have changed.</p>
</div>
<div id="what-happened-to-my-million-rows-of-data" class="section level3">
<h3>What Happened to My Million Rows of Data?</h3>
<p>When I did my <a href="https://johngoldin.com/2020/02/apple-health-export-part-i/">first post</a>
on the Apple Health Export, I had a total of 4,012,907 rows of
data. My most recent export has only 3,026,367 so about a
million rows smaller even though I have added a whole additional
year of data. What gives?</p>
<p>Fortunately I had an archive of the dataset that I used from a year
earlier. I did a <code>full_join</code> of the two datasets by start time,
end time, and type. It was very easy to spot the source of the change.
At some point during the last year Apple changed how the
export handles workouts. Data outside of workouts is unchanged.
For workouts older than 90 days, the export now summarizes the
items that are frequently measured: Active Energy Burned, Basal Energy Burned, Heart Rate, and Distance Walking or Running. The two energy
items and distance are each
summed over a five minute period. Heart rate is the average
over a ten minute period.<br />
Normally heart rate is reported as a whole number, but in
the summarized workout data it is now displayed to one decimal point.</p>
<p>On a typical 65-minute outdoor walk done within the last three months
the export has 1,515 Active Energy and Basal Energy measures,
658 Heart Rate readings, and 1,493 Distance Walking Running measures.
For the same walk done more than three months ago, there are
only 15 Active and Basal Energy measures, 7 Heart Rate, and
13 Distance. There are about one-tenth as many measures
in the older workouts and
each value is a summary for a period of time. Workouts generate
a very large number of measurements so summarizing those
measurements can make a big difference in the size of the exported
dataset.</p>
<p>Does this matter? Summarizing some of the workout detail seems reasonable.
Although one might imagine a hypothetical case where the detail in
the older workouts would be needed, it doesn’t seem like
a practical problem. I write crazy blog posts like this so
in my case I may try to archive a copy of the data every 90 days,
just in case.</p>
<p>I wondered whether the details were removed from the Health Kit data
on my phone or only in the Health Export. When I use the Fitness
app to look at old workouts I can still see all of the detail of the
heart rate measurements. It’s clear that a summary of
workout data is created for the Health Export, but the
actual data remains on the iPhone. So all of the detail is still
there, it’s just not included in the export. Using the premium
version of the <a href="https://apps.apple.com/us/app/heart-analyzer/id1006420410">Heart Analyzer app</a> (which is only $1.99),
one can clearly see that the original heart rate data is
available even for older months that are summarized in the
Health Export.</p>
</div>
<div id="how-do-we-know-what-the-health-measures-actually-measure" class="section level3">
<h3>How Do We Know What the Health Measures Actually Measure?</h3>
<p>Apple wants the Watch to be taken seriously as a medical device.
To take the Health items seriously, one needs to have
confidence in them. Greater transparency would help to support trust.
Apple may not be willing to describe the operational definition
of the summary measurements they provide.
That makes it harder to determine what is actually being measured.
Here we have looked at
resting heart rate and VO2max and alluded to sleep.</p>
<p>There’s an interesting <a href="https://www.theverge.com/2020/10/7/21504023/apple-watch-ekg-blood-oxygen-fda-clearance">article</a> in The Verge by Nicole Wetsman that
discusses why Apple got FDA approval for its EKG feature but not for its
measurement of blood oxygen level.</p>
<blockquote>
<p>Blood oxygen monitors, or pulse oximeters, are considered Class II medical devices by the FDA. Generally, any company that wants to sell one in the United States has to submit documentation to the agency confirming that its product works just as well as other versions of the same product already on the market. There’s a workaround, though: if the company says that the product is just for fun, or for general “wellness,” they don’t have to go through that process.</p>
</blockquote>
<p>It’s convenient for Apple to keep users at arms length and hide the technical details.
That means we get a verbal description of what a measure is supposed to do, but we
may not be able to understand the operational definition of what the measure
actually does. The health measures in many cases are still in an early stage of
development. They will be improved over time. Improvement means change, in a
good way. But it also means that one must be very careful about
the interpretation of long-term trends.</p>
</div>
<div id="appendix-some-of-the-r-code-used-to-make-this-post" class="section level2">
<h2>Appendix: Some of the R Code Used to Make This Post</h2>
<p>In my <a href="/blog/apple-health-export-1/">earlier post</a><br />
I included a lot of R code for setting
up the Health Export data. Here I’ll describe some of the
additional code used for this post. Some of this
code will focus on how to work with the Health Export.
But I also used this post to try some suggested code
for <code>ggplot2</code> so I’ll feature that code here as well.</p>
<div id="r-code-for-the-ggplot2-figures" class="section level3">
<h3>R Code for the <code>ggplot2</code> Figures</h3>
<p>The figures relied on the <code>ggtext</code> and
<code>ggforce</code> packages to add some extras to
figures based on
<a href="https://z3tt.github.io/OutlierConf2021/">tips from Cédric Scherer</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scico)       <span class="do">## scico color palettes(http://www.fabiocrameri.ch/colourmaps.php) in R </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggtext)      <span class="do">## add improved text rendering to ggplot2</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggforce)     <span class="do">## add missing functionality to ggplot2</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdist)      <span class="do">## add uncertainity visualizations to ggplot2</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)   <span class="do">## combine outputs from ggplot2</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># library(Cairo)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Here is the code to create the Resting Heart Rate plots</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #   #</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># copied directly from: https://github.com/Z3tt/OutlierConf2021/blob/main/R/OutlierConf2021_ggplotWizardry_HandsOn.Rmd</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># You should have package Cairo installed if you use ggsave:</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># i.e., add device = cairo_pdf in ggsave call.</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="do">## change global theme settings (for all following plots)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  IMPORTANT!!! open sans font must be installed (see next line)</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># open sans downloaded from https://fonts.google.com/specimen/Open+Sans?preview.text_type=custom</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># for tips on extra fonts on windows, see https://www.williamrchase.com/post/custom-fonts-and-plot-quality-with-ggplot-on-windows/</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># based on William Chase, I may also try Alegreya Sans from https://www.huertatipografica.com/en/fonts/alegreya-sans-ht</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>, <span class="at">base_family =</span> <span class="st">&quot;Open Sans&quot;</span>)) <span class="co">#originally 12</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="do">## modify plot elements globally (for all following plots)</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_update</span>(</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&quot;grey92&quot;</span>),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">axis.ticks.length =</span> <span class="fu">unit</span>(.<span class="dv">5</span>, <span class="st">&quot;lines&quot;</span>),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&quot;grey30&quot;</span>), </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>),  <span class="co"># originally 18</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">color =</span> <span class="st">&quot;grey30&quot;</span>), <span class="co"># originally 12</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">15</span>))</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># resting_hr &lt;- health_df %&gt;% filter(sourceName == &quot;Watch&quot;) %&gt;% </span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(type == &quot;RestingHeartRate&quot;)</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>dup_resting <span class="ot">&lt;-</span> resting_hr <span class="sc">%&gt;%</span> <span class="fu">count</span>(local_date) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(local_date))</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>hr_versions <span class="ot">&lt;-</span> <span class="fu">unique</span>(resting_hr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(sourceName, <span class="st">&quot;Watch&quot;</span>), <span class="sc">!</span><span class="fu">is.na</span>(sourceVersion)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">select</span>(sourceVersion)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">separate</span>(sourceVersion, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;major&quot;</span>, <span class="st">&quot;minor&quot;</span>, <span class="st">&quot;subminor&quot;</span>), <span class="at">remove =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">subminor =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(subminor), <span class="st">&quot;0&quot;</span>, subminor)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(sourceVersion)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>hr_boundaries <span class="ot">&lt;-</span> resting_hr <span class="sc">%&gt;%</span> </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hr_versions, <span class="at">by =</span> <span class="st">&quot;sourceVersion&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(sourceVersion, local_start, creationDate) <span class="sc">%&gt;%</span> </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sourceVersion, major, minor, subminor) <span class="sc">%&gt;%</span> </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">first_date =</span> <span class="fu">first</span>(local_start), <span class="at">last_date =</span> <span class="fu">last</span>(local_start))</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>hr_boundaries <span class="ot">&lt;-</span> hr_boundaries <span class="sc">%&gt;%</span> </span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(first_date) <span class="sc">%&gt;%</span> </span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">test =</span> <span class="fu">lag</span>(major),</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">test2 =</span> <span class="fu">lead</span>(major),</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">level =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    major <span class="sc">!=</span> <span class="fu">lag</span>(major) <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    minor <span class="sc">!=</span> <span class="fu">lag</span>(minor) <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    subminor <span class="sc">!=</span> <span class="fu">lag</span>(subminor) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>min_date <span class="ot">&lt;-</span> <span class="fu">min</span>(resting_hr<span class="sc">$</span>local_date[resting_hr<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;RestingHeartRate&quot;</span>])</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>max_date <span class="ot">&lt;-</span> <span class="fu">max</span>(resting_hr<span class="sc">$</span>local_date[resting_hr<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;RestingHeartRate&quot;</span>])</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>min_resting_heart_rate <span class="ot">&lt;-</span> <span class="fu">min</span>(resting_hr<span class="sc">$</span>value[resting_hr<span class="sc">$</span>type <span class="sc">==</span> <span class="st">&quot;RestingHeartRate&quot;</span>])</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>half_year_sequence <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">floor_date</span>(min_date, <span class="st">&quot;year&quot;</span>), <span class="fu">ceiling_date</span>(max_date, <span class="st">&quot;year&quot;</span>), <span class="at">by =</span> <span class="st">&quot;quarter&quot;</span>)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>half_year_sequence <span class="ot">&lt;-</span> half_year_sequence[<span class="fu">month</span>(half_year_sequence) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)]</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>p_noversion1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> resting_hr, <span class="fu">aes</span>(<span class="at">x =</span> local_date, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> .<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">limits =</span> <span class="fu">c</span>(min_date <span class="sc">+</span> <span class="dv">0</span>, max_date <span class="sc">-</span> <span class="dv">0</span>), </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>               <span class="at">date_labels =</span> <span class="st">&quot;%b %Y&quot;</span>,</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> half_year_sequence)  <span class="sc">+</span> </span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">45</span>, <span class="dv">65</span>, <span class="at">by =</span> <span class="dv">5</span>), </span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limits =</span> <span class="fu">c</span>(min_resting_heart_rate, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;My Resting Heart Rate by Day&#39;</span>, </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Data from Apple Watch via Health Export&#39;</span>,</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Resting Heart Rate&#39;</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave(&quot;temp.png&quot;, p_noversion1, width = 9, height = 8, device = cairo_pdf, dpi = &quot;retina&quot;)</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="co">#  as.hexmode(col2rgb(&quot;seagreen3&quot;))   # #43cd80  (to use with HTML)</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="co"># I could have added some R code to create the HTML, but this is easier</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>p_noversion2 <span class="ot">&lt;-</span> p_noversion1 <span class="sc">+</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">fill =</span> <span class="st">&quot;lightgrey&quot;</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>p_version0 <span class="ot">&lt;-</span> p_noversion1 <span class="sc">+</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&#39;&lt;i style=&quot;color:#28A87D;&quot;&gt;Vertical lines show major and minor versions of Watch OS&lt;/i&gt;&#39;</span>) <span class="sc">+</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> ggtext<span class="sc">::</span><span class="fu">element_markdown</span>())</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>p_version1 <span class="ot">&lt;-</span> p_version0 <span class="sc">+</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> hr_boundaries <span class="sc">%&gt;%</span> <span class="fu">filter</span>(level <span class="sc">==</span> <span class="dv">3</span>), </span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(first_date)), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;seagreen3&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_richtext</span>(<span class="at">data =</span> hr_boundaries <span class="sc">%&gt;%</span> <span class="fu">filter</span>(level <span class="sc">==</span> <span class="dv">3</span>),</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">&quot;**v&quot;</span>, sourceVersion, <span class="st">&quot;**&quot;</span>), <span class="at">x =</span> <span class="fu">as_date</span>(first_date), <span class="at">y =</span> <span class="cn">Inf</span>), </span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">&quot;seagreen3&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">nudge_x =</span> <span class="dv">5</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> hr_boundaries <span class="sc">%&gt;%</span> <span class="fu">filter</span>(level <span class="sc">==</span> <span class="dv">2</span>), </span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(first_date)), <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">colour =</span> <span class="st">&quot;seagreen2&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>)</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>p_version2 <span class="ot">=</span> p_version1 <span class="sc">+</span> <span class="fu">geom_smooth</span>(<span class="at">fill =</span> <span class="st">&quot;lightgrey&quot;</span>)</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>big_change <span class="ot">&lt;-</span> hr_boundaries<span class="sc">$</span>first_date[hr_boundaries<span class="sc">$</span>sourceVersion <span class="sc">==</span> <span class="st">&quot;7.0&quot;</span>] <span class="sc">%&gt;%</span> <span class="fu">as_date</span>()</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>p_version3 <span class="ot">&lt;-</span> p_version1 <span class="sc">+</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> resting_hr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(local_date <span class="sc">&lt;</span> big_change)) <span class="sc">+</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">data =</span> resting_hr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(local_date <span class="sc">&gt;=</span> big_change)) </span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>p_tod1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> resting_hr, <span class="fu">aes</span>(<span class="at">x =</span> local_date, <span class="at">y =</span> </span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">as.integer</span>(<span class="fu">difftime</span>(local_end, <span class="fu">floor_date</span>(local_end, <span class="st">&quot;day&quot;</span>), <span class="at">unit =</span> <span class="st">&quot;secs&quot;</span>)) <span class="sc">%&gt;%</span> hms<span class="sc">::</span><span class="fu">hms</span>())) <span class="sc">+</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span> </span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> hr_boundaries <span class="sc">%&gt;%</span> <span class="fu">filter</span>(level <span class="sc">==</span> <span class="dv">3</span>), </span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(first_date)), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;seagreen3&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_richtext</span>(<span class="at">data =</span> hr_boundaries <span class="sc">%&gt;%</span> <span class="fu">filter</span>(level <span class="sc">==</span> <span class="dv">3</span>),</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">&quot;**v&quot;</span>, sourceVersion, <span class="st">&quot;**&quot;</span>), <span class="at">x =</span> <span class="fu">as_date</span>(first_date), <span class="at">y =</span> <span class="cn">Inf</span>), </span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>            <span class="at">colour =</span> <span class="st">&quot;seagreen3&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">nudge_x =</span> <span class="dv">5</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> hr_boundaries <span class="sc">%&gt;%</span> <span class="fu">filter</span>(level <span class="sc">==</span> <span class="dv">2</span>), </span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(first_date)), <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">colour =</span> <span class="st">&quot;seagreen2&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">data =</span> hr_boundaries <span class="sc">%&gt;%</span> <span class="fu">filter</span>(level <span class="sc">==</span> <span class="dv">1</span>), </span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as_date</span>(first_date)), <span class="at">size =</span> <span class="fl">0.3</span>, <span class="at">colour =</span> <span class="st">&quot;seagreen1&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">limits =</span> <span class="fu">c</span>(min_date <span class="sc">+</span> <span class="dv">0</span>, max_date <span class="sc">-</span> <span class="dv">0</span>), </span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>               <span class="at">date_labels =</span> <span class="st">&quot;%b %Y&quot;</span>,</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks =</span> half_year_sequence)  <span class="sc">+</span> </span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_time</span>(<span class="at">labels =</span> <span class="cf">function</span>(l) <span class="fu">strftime</span>(l, <span class="st">&#39;%H:%M&#39;</span>)) <span class="sc">+</span>  <span class="co"># thanks to https://stackoverflow.com/a/50173616/5828243</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;My Resting Heart Rate endDate Shown as Time of Day&#39;</span> , </span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;&lt;i style=&quot;color:#28A87D;&quot;&gt;Vertical lines show major and minor versions of Watch OS&lt;/i&gt;&#39;</span>,</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Resting Heart Rate endDate (hours:minutes)&#39;</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> ggtext<span class="sc">::</span><span class="fu">element_markdown</span>(),</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> ggtext<span class="sc">::</span><span class="fu">element_markdown</span>())</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="co"># one can use the lines below to examine outliers</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a><span class="co"># resting_hr %&gt;%</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(sourceVersion &gt; &quot;7.&quot;, </span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a><span class="co">#          as.integer(difftime(local_end, floor_date(local_end, &quot;day&quot;), unit = &quot;secs&quot;)) &gt; hms::hms(0,0,21)) %&gt;%</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(value, local_start, local_end, creationDate, sourceVersion) %&gt;%</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a><span class="co">#   View()</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a><span class="co"># p_tod1 + geom_point(data = resting_hr %&gt;% filter(sourceVersion &gt; &quot;7.&quot;, as.integer(difftime(local_end, floor_date(local_end, &quot;day&quot;), unit = &quot;secs&quot;)) &gt; hms::hms(0,0,23)), colour = &quot;red&quot;, size = 0.6, alpha = 0.6)</span></span></code></pre></div>
</div>
<div id="removing-duplicate-rows-in-the-export" class="section level3">
<h3>Removing Duplicate Rows in the Export</h3>
<p>While working on this post I discovered that there were a fair number of
duplicate rows in the Apple Health Export. Most of these are related to
non-Apple sources such as Lose It! or my Omron blood pressure cuff. But
there were some duplicates for other items as well. So I added a step to
my import to delete duplicates. One needs to exclude the <code>device</code> column
before looking for duplicates.</p>
<p>Generally there is one row of resting heart rate data for each date. But
sometimes a second rows is created, possibly when the iPhone is restarted
as part of an update or if there is a time change for daylight savings.</p>
<p>Here are the revised lines that eliminate the duplicate rows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>      health_df <span class="ot">&lt;-</span> XML<span class="sc">:::</span><span class="fu">xmlAttrsToDataFrame</span>(health_xml[<span class="st">&quot;//Record&quot;</span>], <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">as.numeric</span>(value)) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>device)  <span class="co"># the device column seems to cause some duplicate rows</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>      check_count <span class="ot">&lt;-</span> <span class="fu">nrow</span>(health_df)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>      health_df <span class="ot">&lt;-</span> health_df <span class="sc">%&gt;%</span> <span class="fu">unique</span>()   <span class="co"># unique adds at least two minutes. </span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Had found 42,364 rows, mostly Lose It!, SleepMatic, and Omron, but some came from Watch and iPhone</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      dup_count <span class="ot">&lt;-</span> check_count <span class="sc">-</span> <span class="fu">nrow</span>(health_df)</span></code></pre></div>
</div>
</div>
